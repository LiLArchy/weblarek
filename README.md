# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/main.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

# Интернет-магазин «Web-Larёk»

«Web-Larёk» — это интернет-магазин с товарами для веб-разработчиков, где пользователи могут просматривать товары, добавлять их в корзину и оформлять заказы. Сайт предоставляет удобный интерфейс с модальными окнами для просмотра деталей товаров, управления корзиной и выбора способа оплаты, обеспечивая полный цикл покупки с отправкой заказов на сервер.

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP (Model-View-Presenter), которая обеспечивает четкое разделение ответственности между классами слоев Model и View. Каждый слой несет свой смысл и ответственность:

Model - слой данных, отвечает за хранение и изменение данных.  
View - слой представления, отвечает за отображение данных на странице.  
Presenter - презентер содержит основную логику приложения и отвечает за связь представления и данных.

Взаимодействие между классами обеспечивается использованием событийно-ориентированного подхода. Модели и Представления генерируют события при изменении данных или взаимодействии пользователя с приложением, а Презентер обрабатывает эти события используя методы как Моделей, так и Представлений.

### Базовый код

#### Класс Component

Является базовым классом для всех компонентов интерфейса.
Класс является дженериком и принимает в переменной `T` тип данных, которые могут быть переданы в метод `render` для отображения.

Конструктор:  
`constructor(container: HTMLElement)` - принимает ссылку на DOM элемент за отображение, которого он отвечает.

Поля класса:  
`container: HTMLElement` - поле для хранения корневого DOM элемента компонента.

Методы класса:  
`render(data?: Partial<T>): HTMLElement` - Главный метод класса. Он принимает данные, которые необходимо отобразить в интерфейсе, записывает эти данные в поля класса и возвращает ссылку на DOM-элемент. Предполагается, что в классах, которые будут наследоваться от `Component` будут реализованы сеттеры для полей с данными, которые будут вызываться в момент вызова `render` и записывать данные в необходимые DOM элементы.  
`setImage(element: HTMLImageElement, src: string, alt?: string): void` - утилитарный метод для модификации DOM-элементов `<img>`

#### Класс Api

Содержит в себе базовую логику отправки запросов.

Конструктор:  
`constructor(baseUrl: string, options: RequestInit = {})` - В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Поля класса:  
`baseUrl: string` - базовый адрес сервера  
`options: RequestInit` - объект с заголовками, которые будут использованы для запросов.

Методы:  
`get(uri: string): Promise<object>` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер  
`post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise<object>` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.  
`handleResponse(response: Response): Promise<object>` - защищенный метод проверяющий ответ сервера на корректность и возвращающий объект с данными полученный от сервера или отклоненный промис, в случае некорректных данных.

### Слой коммуникации

Класс `WebLarekApi` является представителем коммуникационного слоя для приложения «Web-Larёk». Он использует композицию: в конструктор передается объект, реализующий интерфейс `IApi` (базовый класс `Api` из стартера его реализует). Внутри методов класса вызываются `get` и `post` для общения с сервером.

- Конструктор: `constructor(api: IApi)` — принимает экземпляр базового API.
- Методы:
  - `getProducts(): Promise<IProduct[]>` — выполняет GET-запрос на эндпоинт `/product/` и возвращает массив товаров (`IProduct[]`).
  - `createOrder(data: IOrderRequest): Promise<IOrderResponse>` — выполняет POST-запрос на эндпоинт `/order/`, отправляя данные о покупателе и выбранных товарах в формате, соответствующем коллекции Postman, и возвращает ответ сервера.

Типы данных:

- `IProductListResponse` — объект ответа каталога `{ total: number; items: IProduct[] }`.
- `IOrderRequest` — данные заказа: поля `IBuyer` + `items: string[]` (id товаров) + `total: number`.
- `IOrderResponse` — ответ сервера при оформлении заказа `{ id: string; total: number }`.

Использование в `src/main.ts`: после тестового кода моделей создается экземпляр `WebLarekApi`, вызывается `getProducts()`, полученный массив сохраняется в `ProductCatalogModel`, и выводится в консоль для проверки.

#### Класс EventEmitter

Брокер событий реализует паттерн "Наблюдатель", позволяющий отправлять события и подписываться на события, происходящие в системе. Класс используется для связи слоя данных и представления.

Конструктор класса не принимает параметров.

Поля класса:  
`_events: Map<string | RegExp, Set<Function>>)` - хранит коллекцию подписок на события. Ключи коллекции - названия событий или регулярное выражение, значения - коллекция функций обработчиков, которые будут вызваны при срабатывании события.

Методы класса:  
`on<T extends object>(event: EventName, callback: (data: T) => void): void` - подписка на событие, принимает название события и функцию обработчик.  
`emit<T extends object>(event: string, data?: T): void` - инициализация события. При вызове события в метод передается название события и объект с данными, который будет использован как аргумент для вызова обработчика.  
`trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие с передачей в него данных из второго параметра.

## Данные

В приложении используются две основные сущности данных — товар и покупатель. Эти сущности описываются интерфейсами ниже. Они определяют структуру данных и служат контрактом между слоем данных (Model), представлением (View) и презентером (Presenter).

Типы и интерфейсы (TypeScript):

```ts
// Способ оплаты
export type TPayment = "online" | "cash";

// Товар каталога
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
}

// Покупатель и данные для оформления заказа
export interface IBuyer {
  payment: TPayment;
  email: string;
  phone: string;
  address: string;
}
```

Назначение интерфейсов:

- `TPayment`: описывает допустимые способы оплаты, используемые при оформлении заказа.
- `IProduct`: контракт на данные товара (отображение карточки, детальная карточка, корзина, расчёт итоговой стоимости).
- `IBuyer`: контракт на данные покупателя, которые требуются для оформления заказа и его валидации.

## Модели данных

Ниже описаны модели слоя данных (Model), их назначение, конструкторы, поля и методы. Эти модели инкапсулируют состояние и предоставляют удобные методы для работы с данными приложения.

### Каталог товаров (ProductCatalogModel)

Назначение и зона ответственности:

- Хранит массив всех доступных товаров.
- Хранит товар, выбранный для подробного отображения (детальной карточки).
- Предоставляет методы загрузки/сохранения, получения и поиска товаров.

Конструктор:

- `constructor()` — без параметров.

Поля класса:

- `products: IProduct[]` — массив всех товаров каталога.
- `selectedProduct: IProduct | null` — выбранный товар для подробного отображения или `null`, если не выбран.

Методы класса:

- `setProducts(products: IProduct[]): void` — сохраняет массив товаров, полученный параметром.
- `getProducts(): IProduct[]` — возвращает текущий массив товаров из модели.
- `getProductById(id: string): IProduct | undefined` — возвращает один товар по его `id` или `undefined`, если товар не найден.
- `setSelectedProduct(product: IProduct | null): void` — сохраняет товар для подробного отображения (или снимает выбор, если `null`).
- `getSelectedProduct(): IProduct | null` — возвращает товар, выбранный для подробного отображения, либо `null`.

### Корзина (CartModel)

Назначение и зона ответственности:

- Хранит товары, выбранные пользователем для покупки.
- Управляет составом корзины и предоставляет агрегированные данные (количество и сумма).

Конструктор:

- `constructor()` — без параметров.

Поля класса:

- `items: IProduct[]` — массив товаров, добавленных в корзину.

Методы класса:

- `getItems(): IProduct[]` — возвращает массив товаров, находящихся в корзине.
- `addItem(product: IProduct): void` — добавляет товар, переданный параметром, в массив корзины.
- `removeItem(productId: string): void` — удаляет товар с указанным `id` из массива корзины.
- `clear(): void` — очищает корзину (удаляет все товары).
- `getTotal(): number` — возвращает суммарную стоимость всех товаров в корзине (цена `null` учитывается как `0`).
- `getCount(): number` — возвращает количество товаров в корзине.
- `hasItem(productId: string): boolean` — проверяет наличие товара с заданным `id` в корзине.

### Покупатель (BuyerModel)

Назначение и зона ответственности:

- Хранит и валидирует данные, необходимые для оформления заказа: способ оплаты, адрес, телефон, email.
- Предоставляет интерфейс для записи, получения и очистки данных покупателя.

Конструктор:

- `constructor()` — без параметров.

Поля класса:

- `payment: TPayment` — выбранный способ оплаты.
- `address: string` — адрес доставки.
- `phone: string` — номер телефона покупателя.
- `email: string` — email покупателя.

Методы класса:

- `setData(data: Partial<IBuyer>): void` — сохраняет данные в модели (можно передавать частичные обновления для отдельных полей).
- `getData(): IBuyer` — возвращает все данные покупателя как объект `IBuyer`.
- `clear(): void` — очищает данные покупателя и сбрасывает поля к значениям по умолчанию.
- `validate(): { valid: boolean; errors: Partial<Record<keyof IBuyer, string>> }` — выполняет валидацию данных (проверка обязательных полей, корректности форматов телефона и email), возвращает результат и описание ошибок по полям (если есть).

## Слой представления (View)

Слой представления отвечает за отображение данных и взаимодействие пользователя с интерфейсом. Каждый класс отвечает за свой самостоятельный блок разметки. Наследование используется только там, где есть повторяющийся UI‑функционал: для карточек товаров и для форм. Модальное окно — отдельный, нерасширяемый компонент; содержимое модалок — самостоятельные компоненты, их можно отрисовывать где угодно (в т.ч. внутри модального окна).

### Базовые соглашения

- **Родитель всех вью‑классов**: `Component<T>` (см. раздел «Базовый код»). Методы рендера и утилиты работы с DOM наследуются от него.
- **События**: View публикуют события пользовательских действий (клики, ввод данных) через брокер событий, а также принимают данные для отображения от презентера.

### Разметка страницы

#### PageView

Назначение: корневой контейнер страницы, управляет общими состояниями интерфейса.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `content: HTMLElement` — основной контент (каталог/списки).
  - `locked: boolean` — признак блокировки скролла при открытом модальном окне.
- Методы:
  - `setLocked(state: boolean): void` — включает/выключает блокировку скролла/body.
  - `render(data?: void): HTMLElement` — возвращает корневой контейнер.

#### HeaderView

Назначение: шапка сайта; отображает логотип, счётчик корзины и кнопки.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `cartCounter: HTMLElement` — индикатор количества товаров.
- Методы:
  - `setCartCount(count: number): void` — обновляет счётчик.
  - `onCartClick(handler: () => void): void` — подписка на клик по кнопке корзины.

### Каталог товаров

#### CatalogView

Назначение: список карточек товаров (сетка каталога). Управляет монтированием/очисткой списка и делегированием событий карточек наружу.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `list: HTMLElement` — контейнер списка карточек.
- Методы:
  - `setItems(nodes: HTMLElement[]): void` — заменяет содержимое списка массивом карточек.
  - `clear(): void` — очищает список.

### Карточки товара (общее и частные реализации)

Для работы с разными темплейтами карточек используется общий родитель и три дочерних класса. Общий функционал (установка картинки, заголовка, категории, цены, обработчики кликов) вынесен в базовый класс.

#### AbstractCardView<TCard>

Назначение: абстрактный базовый класс карточки товара.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `id: string` — идентификатор товара.
  - `titleEl: HTMLElement` — узел заголовка.
  - `imageEl: HTMLImageElement` — узел изображения.
  - `categoryEl: HTMLElement` — узел категории.
  - `priceEl: HTMLElement` — узел цены.
- Методы:
  - `setId(id: string): void`
  - `setTitle(title: string): void`
  - `setImage(src: string, alt?: string): void`
  - `setCategory(category: string): void`
  - `setPrice(price: number | null): void` — отображает «Бесценно» при `null`.
  - `onClick(handler: (id: string) => void): void` — общий обработчик клика по карточке.
  - `render(data: TCard): HTMLElement` — заполняет общие поля и возвращает DOM‑элемент.

Дочерние классы:

#### CatalogCardView extends AbstractCardView<IProduct>

Назначение: карточка в каталоге. Имеет кнопку «В корзину»/«Убрать» и состояние, зависящее от наличия товара в корзине.

- Доп. поля: `buttonEl: HTMLButtonElement`.
- Доп. методы:
  - `setInCart(inCart: boolean): void` — переключает текст/стили кнопки.
  - `onAddToCart(handler: (id: string) => void): void` — обработчик клика по кнопке.

#### PreviewCardView extends AbstractCardView<IProduct>

Назначение: крупная карточка для попапа предпросмотра товара (детали). Не содержит кнопки добавления; событие клика по кнопке «Купить» делегируется наружу, если предусмотрено макетом.

- Доп. поля: `descriptionEl: HTMLElement`.
- Доп. методы: `setDescription(text: string): void`.

#### CartItemView extends AbstractCardView<IProduct>

Назначение: компактная карточка товара в корзине.

- Отличия: иной темплейт (минимум изображение/заголовок/цена), кнопка удаления.
- Доп. поля: `removeButtonEl: HTMLButtonElement`.
- Доп. методы: `onRemove(handler: (id: string) => void): void`.

### Корзина

#### CartView

Назначение: компонент корзины, отображает список товаров, итоговую стоимость и кнопки действий.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `list: HTMLElement` — контейнер списка `CartItemView`.
  - `totalEl: HTMLElement` — узел с итоговой суммой.
  - `orderButtonEl: HTMLButtonElement` — кнопка «Оформить».
- Методы:
  - `setItems(items: HTMLElement[]): void` — отрисовывает позиции корзины.
  - `setTotal(total: number): void` — отображает сумму.
  - `onSubmit(handler: () => void): void` — обработчик клика «Оформить».
  - `onClear(handler: () => void): void` — обработчик «Очистить корзину», если предусмотрено макетом.

### Формы оформления заказа

Две формы имеют общего родителя с вынесенной общей логикой: управление состоянием кнопки отправки, отображение ошибок валидации, чтение/запись полей.

#### BaseFormView<T>

Назначение: общий функционал для всех форм.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `submitButtonEl: HTMLButtonElement`
  - `errorsEl?: HTMLElement` — контейнер ошибок.
- Методы:
  - `setDisabled(state: boolean): void` — включает/выключает кнопку отправки.
  - `setErrors(errors: Partial<Record<keyof T, string>>): void` — показывает ошибки по полям.
  - `onChange(handler: (data: Partial<T>) => void): void` — делегированное событие изменения полей.
  - `onSubmit(handler: () => void): void` — сабмит формы.

#### OrderFormView extends BaseFormView<Pick<IBuyer, 'payment' | 'address'>>

Назначение: форма способа оплаты и адреса доставки.

- Поля: `paymentInputs`, `addressInput`.
- Методы: `setPayment(value: TPayment): void`, `setAddress(value: string): void`.

#### ContactsFormView extends BaseFormView<Pick<IBuyer, 'email' | 'phone'>>

Назначение: форма контактных данных.

- Поля: `emailInput`, `phoneInput`.
- Методы: `setEmail(value: string): void`, `setPhone(value: string): void`.

### Модальные окна

Модальное окно — самостоятельный компонент без наследников. Конкретные содержимые (предпросмотр товара, корзина, формы, экран успеха) — отдельные компоненты, которые передаются модалке и монтируются внутрь неё. Это позволяет те же компоненты при необходимости монтировать вне модалки.

#### ModalView

Назначение: отвечает за открытие/закрытие модального окна и монтирование произвольного контента.

- Конструктор: `constructor(container: HTMLElement)`.
- Поля:
  - `contentEl: HTMLElement` — контейнер для контента.
  - `closeButtonEl: HTMLButtonElement` — кнопка закрытия.
  - `isOpen: boolean` — состояние модалки.
- Методы:
  - `open(node: HTMLElement): void` — открывает модалку и монтирует переданный узел.
  - `close(): void` — закрывает модалку и очищает контент.
  - `onClose(handler: () => void): void` — обработчик закрытия (кнопка/оверлей/ESC).

### Прочие компоненты модальных окон

Эти компоненты — обычные View и могут использоваться как внутри модалки, так и в любом другом месте.

#### ProductPreviewView

Назначение: детальная карточка товара для предпросмотра (использует `PreviewCardView` внутри).

#### OrderSuccessView

Назначение: экран успешного оформления заказа; показывает номер заказа/итоговую сумму и кнопку закрытия/возврата в каталог.

---

Этого набора классов достаточно для реализации логики сайта согласно макету: каталог -> предпросмотр товара в модалке -> добавление в корзину -> оформление заказ двумя формами -> экран успеха. Карточки и формы разделяют общий функционал в родителях, модалка не имеет наследников, а её содержимое — самостоятельные компоненты.

## Презентер

В проекте используется один презентер (ради простоты — код в `src/main.ts`), который связывает Модели (Model) и Представления (View) через событийный брокер. Презентер не генерирует события, он только подписывается на события от моделей и представлений, изменяет данные через модели и инициирует рендеринг только в двух случаях:

- При получении события изменения данных от модели
- При открытии модального окна (когда необходимо отрисовать его содержимое)

Основные обязанности презентера:

- Инициализация моделей (`ProductCatalogModel`, `CartModel`, `BuyerModel`) с передачей брокера событий.
- Инициализация представлений (`CatalogView`, `ModalView`, карточки, корзина, формы) и установка обработчиков пользовательских событий.
- Подписка на события моделей: `catalog:changed`, `product:selected:changed`, `cart:changed`, `buyer:changed` и реакция на них (обновление соответствующих представлений).
- Подписка на события представлений (ниже) и вызов методов моделей без непосредственного рендера (рендер произойдет по событиям моделей или при открытии модалки).

Выбранный подход: презентер реализован в `main.ts` без отдельного класса. Это упрощает структуру и сохраняет принципы MVP за счет четкого разделения обязанностей и событийной связи.

## События приложения

Ниже перечислены события, которые генерируются компонентами приложения и обрабатываются презентером.

События моделей:

- `catalog:changed` — изменился массив товаров каталога. Действие: собрать карточки каталога через `CatalogCardView` и передать их в `CatalogView.setItems()`.
- `product:selected:changed` — изменился выбранный товар (при необходимости).
- `cart:changed` — изменилось содержимое корзины. Действие: обновить счетчик корзины в шапке, при открытом модальном окне корзины — перерисовать её содержимое.
- `buyer:changed` — изменились данные покупателя (форма заказа/контактов).

События представлений:

- `view:product:selected` — пользователь кликнул карточку в каталоге. Действие: открыть модалку предпросмотра, отрисовать `PreviewCardView`.
- `view:product:addToCart` — пользователь нажал «В корзину» в предпросмотре. Действие: добавить товар в `CartModel`, закрыть модалку.
- `view:cart:open` — пользователь нажал кнопку корзины в шапке. Действие: открыть модалку корзины, отрисовать `CartView` и список `CartItemView`.
- `view:order:open` — пользователь нажал «Оформить» в корзине. Действие: открыть модалку формы заказа `OrderFormView`.
- `view:contacts:open` — пользователь нажал «Далее» в первой форме. Действие: открыть модалку формы контактов `ContactsFormView`.
- `view:order:success` — пользователь завершил оформление во второй форме. Действие: показать экран успеха.
- `modal:closed` — модалка закрыта (крестик/оверлей/Esc).

Примечание: презентер не генерирует эти события; они приходят от View или Models. В обработчиках презентера меняются данные моделей и/или открываются модальные окна; перерисовка каталога и счётчика корзины инициируются событиями моделей.
